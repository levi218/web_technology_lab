!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=5)}([function(e,t){e.exports=require("connect-ensure-login")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("passport")},function(e,t,n){t.data=n(8),t.findByUsername=function(e,n){process.nextTick((function(){for(var i=0,r=t.data.participants.length;i<r;i++){var s=t.data.participants[i];if(s.name===e)return n(null,s)}return n(null,null)}))}},function(e,t){e.exports=require("debug")},function(e,t,n){const i=n(1),r=n(6);var s=n(2),o=n(7).Strategy,u=n(3),a=n(9),c=n(10),d=n(4)("https");s.use(new o((function(e,t,n){u.findByUsername(e,(function(e,t){return e?n(e):n(null,t||!1)}))}))),s.serializeUser((function(e,t){t(null,e.name)})),s.deserializeUser((function(e,t){u.findByUsername(e,(function(e,n){if(e)return t(e);t(null,n)}))}));let m=i();m.use(r({createParentPath:!0}));const p=n(11),l=n(12);m.use(l()),m.use(p.json()),m.use(p.urlencoded({extended:!0})),m.use(n(13)("combined")),m.use(n(14)({secret:"keyboard cat",resave:!1,saveUninitialized:!1})),m.use(s.initialize()),m.use(s.session());const f=n(15);m.set("view engine","pug"),m.set("views","./src"),m.use(i.static("public")),m.use(i.static("node_modules/socket.io-client/dist")),m.use("/",f),c.createServer({key:a.readFileSync("./cert/cert.key"),cert:a.readFileSync("./cert/cert.csr")},m).listen(3e3,(function(){d("listening")}))},function(e,t){e.exports=require("express-fileupload")},function(e,t){e.exports=require("passport-local")},function(e){e.exports=JSON.parse('{"lastId":4,"settings":{"start_time":"2019-10-22T02:58:00.000","timeout":30,"info_time":5,"countdown":10},"participants":[{"name":"admin"},{"name":"user2","money_reserve":10000}],"list":[{"itemId":0,"author":"Author 1","name":"Item 1","description":"Description 1","picture":"1.jpg","start_price":500,"min_bidding_step":100},{"itemId":1,"author":"Author 2","name":"Item 2","description":"Description 1","picture":"2.jpg","start_price":600,"min_bidding_step":100},{"itemId":2,"author":"Author 3","name":"Item 3","description":"Description 1","picture":"3.jpg","start_price":400,"min_bidding_step":100},{"itemId":3,"author":"Author 4","name":"Item 4","description":"Description 1","picture":"4.jpg","start_price":300,"min_bidding_step":100},{"itemId":4,"author":"Author 5","name":"Item 5","description":"Description 1","picture":"5.jpg","start_price":700,"min_bidding_step":100}]}')},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("express-session")},function(e,t,n){const i=n(1).Router();var r=n(2);let s=n(3);debug=n(4)("router");const o=n(16).listen(3030);o.sockets.on("connection",(function(e){})),debug("Loaded: "+s);var u,a=s.data.list[0],c=[],d=0;i.get("/",n(0).ensureLoggedIn(),(e,t)=>{"admin"!==e.user.name?t.render("_participantPage",{user:e.user,item:a,status:d}):t.render("_adminPage",{user:e.user,items:s.data.list,participants:s.data.participants.filter(e=>"admin"!=e.name)})}),i.get("/history",n(0).ensureLoggedIn(),(e,t)=>{"admin"!==e.user.name?(debug(s.data.list),t.render("_historyPage",{user:e.user,items:s.data.list.filter(t=>t.soldTo&&t.soldTo.user==e.user.name)})):t.status(404).end("Page not found")}),i.get("/detail/:id",n(0).ensureLoggedIn(),(e,t)=>{let n=s.data.list.find(t=>t.itemId==e.params.id);n&&null!=n||t.status(404).end("Page not found"),t.render("itemDetail",{user:e.user,data:n})}),i.get("/current_participants",(e,t)=>{t.status(200).render("participantList",{item:a})}),i.get("/user_info",(e,t)=>{t.status(200).json({user:e.user})}),i.get("/items",(e,t)=>{t.status(200).render("itemList",{items:s.data.list})}),i.get("/current_item",(e,t)=>{t.status(200).render("itemInfo",{item:a,status:d})}),i.post("/bid",(e,t)=>{let n=e.body;e.user&&(n.user=e.user.name),n.price=parseFloat(n.price),e.user.money_reserve<n.price?t.status(200).json({error:"Reserve not enough"}):0!=c.length&&n.price<c[0].price+a.min_bidding_step?t.status(200).json({error:"Bid annot be lower than current highest plus minimum bidding step"}):n.price<a.start_price?t.status(200).json({error:"Lower than starting price ("+a.start_price+")"}):(c.push(n),c=c.sort((e,t)=>t.price-e.price),t.status(200).json({status:"ok"}))});var m=new Promise((function(e,t){setTimeout((function t(){let n=new Date(s.data.settings.start_time),i=new Date;time_left=parseInt((n-i)/1e3),time_left<=0?(debug("Auction started!"),o.emit("auction_start"),d+=1,e()):(debug("Time until auction start: "+time_left),o.emit("auction_start_cd",time_left),setTimeout(t,1e3))}))}));for(let e of s.data.list)m=m.then((function(t){return a=e,debug("Item information: "+JSON.stringify(a)),o.emit("item_changed",JSON.stringify(a)),0})).then((function(e){return new Promise((function(e,t){u=new Date;var n=s.data.settings.info_time;setTimeout((function t(){let i=new Date;time_left=parseInt((i-u)/1e3),time_left<=n?(debug("Information time: "+(n-time_left)),o.emit("information_time_cd",n-time_left),setTimeout(t,1e3)):(debug("Information time is over"),o.emit("information_time_over"),e(0))}),1e3)}))})).then((function(e){return new Promise((function(e,t){var n=s.data.settings.info_time,i=s.data.settings.countdown,r=s.data.settings.timeout,a=0;c=[];setTimeout((function t(){let d=new Date;if(time_left=parseInt((d-u)/1e3),!(time_left<=n+r))return e(1),debug("Auction time for this item is over"),void o.emit("auction_over");if(debug("Time until auction for this item ends: "+(n+r-time_left)),o.emit("auction_time_cd",n+r-time_left),c.length>0)if(c.length==a){if(!(i>0))return e(0),void o.emit("auction_over");i--,debug("Countdown until bidding ends: "+i),o.emit("countdown",i)}else a=c.length,i=s.data.settings.countdown,debug("Highest price: "+JSON.stringify(c[0])),o.emit("price_changed",c[0].price);setTimeout(t,1e3)}),1e3)}))})).then((function(e){if(0!=e)return debug("Auction for this item has ended with no buyer"),o.emit("announce_buyer",null),0;for(var t of(s.data.list.find(e=>e.itemId==a.itemId).soldTo=c[0],debug("Item sold to "+JSON.stringify(c)),o.emit("announce_buyer",c[0].user),s.data.participants))t.name==c[0].user&&(t.money_reserve-=c[0].price);o.emit("balance_updated")}));m.then((function(e){return a=null,d=2,o.emit("session_ended"),0})),i.get("/login",(function(e,t){e.user?t.redirect("/"):t.render("login")})),i.post("/login",r.authenticate("local",{failureRedirect:"/login"}),(function(e,t){t.redirect("/")})),i.get("/logout",(function(e,t){e.logout(),t.redirect("/")})),i.get("*",(e,t)=>{t.status(404),t.end("Page not found")}),e.exports=i},function(e,t){e.exports=require("socket.io")}]);